name: Update Database (Incremental)

on:
  schedule:
    # Run hourly at minute 13
    - cron: "13 * * * *"
  workflow_dispatch:

jobs:
  update_db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: cd scripts && poetry install

      - name: Download existing database from R2
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3
        with:
          command: r2 object get server-radar/sb.duckdb -f static/sb.duckdb.wasm -J eu
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        continue-on-error: true  # First run won't have existing DB

      - name: Run incremental update
        run: |
          cd scripts && poetry run python update_incremental.py ../static/sb.duckdb.wasm 90

      - name: Deploy DB to R2
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3
        with:
          command: r2 object put server-radar/sb.duckdb -f static/sb.duckdb.wasm -J eu
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  notify_failure:
    runs-on: ubuntu-latest
    needs: update_db
    if: failure() && github.ref == 'refs/heads/main'
    steps:
      - name: Send ntfy.sh notification
        run: |
          curl \
            -H "Title: Server Radar DB update failure" \
            -H "Priority: urgent" \
            -H "Tags: warning" \
            -d "The incremental DB update failed." \
            ntfy.sh/7vGYCNtEtfklA8Wx-wcrawl
